#!/bin/bash
# Exit on error, error on undefined variables
set -eu

# Usage: sudo update-sprite [sprite-type]
usage() { echo "usage: $(basename "$0") [-h] [sprite-type]"; exit 0; }

[[ $# -eq 0 ]] && usage
[[ "$1" == "-h" ]] && usage
[[ -z "$1" ]] && usage

KEY=/var/lib/$1-sprite/.ssh/$1_sprite_pull
REPO_DIR=/opt/$1-sprite
BRANCH=main

export GIT_SSH_COMMAND="ssh -i ${KEY} -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new"

cd "$REPO_DIR"

# Fetch and see if anything changed
old="$(git rev-parse HEAD)"
git fetch origin "$BRANCH"
new="$(git rev-parse "origin/${BRANCH}")"

if [ "$old" = "$new" ]; then
  exit 0
fi

# Fast-forward only; refuse merges
git merge --ff-only "origin/${BRANCH}"

# Restart bot to pick up changes
systemctl restart $1-sprite.service
